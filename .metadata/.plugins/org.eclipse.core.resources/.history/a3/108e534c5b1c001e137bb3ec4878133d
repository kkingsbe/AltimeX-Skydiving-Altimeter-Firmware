/*
 * LPS22HB.c
 *
 *  Created on: Jul 6, 2023
 *      Author: Kyle Kingsberry
 */
#include "LPS22HB.h"

struct LPS_CONFIG lpsConfig;

uint8_t LPS_Init(I2C_HandleTypeDef* i2c_config, uint16_t address)
{
	HAL_Delay(1000);
	lpsConfig.i2c_config = i2c_config;
	lpsConfig.address = address;

	HAL_StatusTypeDef i2c_status = HAL_I2C_IsDeviceReady(i2c_config, (uint16_t)(LPS_DEFAULT_ADDRESS<<1), 3, 5);
	if(i2c_status == HAL_BUSY) {
		return 0;
	}

	LPS_Set_Odr(ODR_75hz);
	return 1;
}

void LPS_Reg_Read(uint16_t reg_addr, uint16_t reg_size, uint8_t* data_output)
{
	HAL_I2C_Mem_Read(lpsConfig.i2c_config, (uint16_t)(lpsConfig.address<<1), reg_addr, 1, data_output, reg_size, 100);
}

//Configures the output data rate (ODR)
void LPS_Set_Odr(enum LPS_ODR new_odr)
{
	//Read the existing configuration from the CTRL_REG 1
	uint8_t existingConfig[1];
	LPS_Reg_Read(CTRL_REG1, 1, existingConfig);

	//Determine the ODR configuration to write to CTRL_REG 1
	uint8_t odr_code = 0;
	if(new_odr == ODR_1hz) odr_code = 0x1;
	if(new_odr == ODR_10hz) odr_code = 0x2;
	if(new_odr == ODR_25hz) odr_code = 0x3;
	if(new_odr == ODR_50hz) odr_code = 0x4;
	if(new_odr == ODR_75hz) odr_code = 0x5;

	//Clear top 4 bits from the existing config
	uint8_t newConfig[1];
	newConfig[0] = existingConfig[0] & 0x0F;

	//Store the new ODR configuration
	newConfig[0] |= (odr_code << 4);

	//Write new ODR to register
	HAL_I2C_Mem_Write(lpsConfig.i2c_config, (uint16_t)(lpsConfig.address<<1), CTRL_REG1, 1, newConfig, 1, 100);

	/*
	uint8_t actualNewConfig[1];
	LPS_Reg_Read(CTRL_REG1, 1, actualNewConfig);
	*/
}

enum LPS_ODR LPS_Get_Odr()
{
	uint8_t existingConfig[1];
	LPS_Reg_Read(CTRL_REG1, 1, existingConfig);
	uint8_t odr_code = (existingConfig[0] >> 4) &| 0x80;
}
